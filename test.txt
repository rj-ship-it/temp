-- NULL business flag that HAVE a company relation (should become TRUE)
select count(*) as null_to_true
from credit_card_accounts a
where a.is_business_account is null
  and exists (
        select 1 from credit_card_company_account_relations r
        where r.account_id = a.account_id
  );

-- NULL business flag that DO NOT have a company relation (should become FALSE)
select count(*) as null_to_false
from credit_card_accounts a
where a.is_business_account is null
  and not exists (
        select 1 from credit_card_company_account_relations r
        where r.account_id = a.account_id
  );

begin;

-- Optional: keep an audit of rows being changed
create temporary table _acct_business_fix_audit as
select a.account_id,
       a.is_business_account as old_is_business_account,
       case when exists (
                 select 1 from credit_card_company_account_relations r
                 where r.account_id = a.account_id
            )
            then true else false end as new_is_business_account
from credit_card_accounts a
where a.is_business_account is null;

-- Update all NULLs based on relation existence
update credit_card_accounts a
set is_business_account = case
    when exists (
         select 1 from credit_card_company_account_relations r
         where r.account_id = a.account_id
    ) then true
    else false
end
where a.is_business_account is null;

commit;

========
-- Company accounts -> TRUE
update credit_card_accounts a
set is_business_account = true
where a.is_business_account is null
  and exists (select 1 from credit_card_company_account_relations r
              where r.account_id = a.account_id);

-- Consumer accounts -> FALSE
update credit_card_accounts a
set is_business_account = false
where a.is_business_account is null
  and not exists (select 1 from credit_card_company_account_relations r
                  where r.account_id = a.account_id);

======

-- Should be zero after the fix
select count(*) as remaining_nulls
from credit_card_accounts
where is_business_account is null;

-- Sanity: spot check distribution
select is_business_account, count(*)
from credit_card_accounts
group by is_business_account;


